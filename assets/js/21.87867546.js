(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{262:function(t,s,e){"use strict";e.r(s);var a=e(28),r=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"optimizing-dockerfile"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#optimizing-dockerfile"}},[t._v("#")]),t._v(" Optimizing Dockerfile")]),t._v(" "),e("p",[t._v("上一個練習 "),e("RouterLink",{attrs:{to:"/docs/exercises/exercises-21-docker-build.html"}},[t._v("Docker Build")]),t._v(" 最後產生的 Dockerfile 如下：")],1),t._v(" "),e("div",{staticClass:"language-dockerfile extra-class"},[e("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" php"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.3"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alpine\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /source\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" curl "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("sS https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//getcomposer.org/installer "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" php\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" mv composer.phar /usr/local/bin/composer\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" . .\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" composer install\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Use only development environment")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENV")]),t._v(" APP_KEY "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"base64:ETwf93f5m2aTbg+YxukR3hEiAHzmvKEi0mt605TkMfU="')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPOSE")]),t._v(" 8080\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"php"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"artisan"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"serve"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--host"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.0.0.0"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--port"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8080"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),e("p",[t._v("事實上，這個 Dockerfile 存一些問題：")]),t._v(" "),e("ul",[e("li",[t._v("建置過程傳入了太多非必要的檔案（指 "),e("code",[t._v("COPY . .")]),t._v("），這會\n"),e("ul",[e("li",[t._v("讓建置時間變久")]),t._v(" "),e("li",[t._v("增加不穩定因素")]),t._v(" "),e("li",[t._v("增加不必要的重覆建置")])])]),t._v(" "),e("li",[e("code",[t._v("ENV")]),t._v(" 使用了機敏資訊（key），代表這會在原始碼裡出現")]),t._v(" "),e("li",[t._v("安裝過程「可能」會有不必要的檔案（指 "),e("code",[t._v("composer install")]),t._v(" 會安裝測試套件）")])]),t._v(" "),e("p",[t._v("因此會需要最佳化 Dockerfile，方向有下列幾個：")]),t._v(" "),e("ul",[e("li",[t._v("減少 build image 的時間，以調整流程為主\n"),e("ul",[e("li",[t._v("也可參考 "),e("a",{attrs:{href:"https://docs.docker.com/engine/reference/builder/#dockerignore-file",target:"_blank",rel:"noopener noreferrer"}},[t._v(".dockerignore"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[t._v("減少 image 空間與 commit，以調整流程為主\n"),e("ul",[e("li",[t._v("也可參考 "),e("a",{attrs:{href:"https://hub.docker.com/_/alpine/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Alpine Linux"),e("OutboundLink")],1),t._v(" 或 "),e("a",{attrs:{href:"https://docs.docker.com/develop/develop-images/multistage-build/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Multi-stage Builds"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[t._v("加強 image 的 SaaS 特性，可參考 "),e("a",{attrs:{href:"https://12factor.net/",target:"_blank",rel:"noopener noreferrer"}},[t._v("The Twelve Factors"),e("OutboundLink")],1)])]),t._v(" "),e("h2",{attrs:{id:"減少-build-context-的大小"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#減少-build-context-的大小"}},[t._v("#")]),t._v(" 減少 build context 的大小")]),t._v(" "),e("p",[t._v("Build context 是執行 build 一開始，會把檔案傳給 Docker Daemon 準備做 build。")]),t._v(" "),e("p",[t._v("但因為有些檔案跟建置無關，如：")]),t._v(" "),e("ul",[e("li",[e("code",[t._v(".vagrant")])])]),t._v(" "),e("p",[t._v("與建置無關很好理解。但有些則會是我們希望它跟 image 無關，如：")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("vendor")])])]),t._v(" "),e("p",[t._v("比方說，為何我們會希望 host 的 vendor 目錄，會跟 image 無關？舉個例子，若 host 的 PHP 版本是 7.3，image 是 7.1 的時候，就很有可能會出問題。如 host 的 PHP 7.3 可能會安裝 PHPUnit 8，但 image PHP 7.1 是不能使用的。")]),t._v(" "),e("p",[t._v("這時，我們可以使用 "),e("code",[t._v(".dockerignore")]),t._v(" 來排除 build context 時的檔案。")]),t._v(" "),e("blockquote",[e("p",[t._v("用法類似 "),e("code",[t._v(".gitignore")]),t._v("。")])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v(".vagrant\nvendor\nbootstrap/cache/packages.php\nbootstrap/cache/services.php\n")])])]),e("p",[t._v("如此一來，建置速度會加快，且某些內容也比較不會受到 host 檔案影響。")]),t._v(" "),e("h2",{attrs:{id:"利用-cache-來減少不必要的重覆建置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#利用-cache-來減少不必要的重覆建置"}},[t._v("#")]),t._v(" 利用 cache 來減少不必要的重覆建置")]),t._v(" "),e("blockquote",[e("p",[t._v("在一個指令完成 commit 後，只要下一次遇到在同個 parent，同個 commit 時，就會繼續使用同一個 commit（類似 Git 的 fast forward）。建置過程如果有使用同一個 commit 則會顯示 "),e("em",[t._v("Using cache")]),t._v(" 的訊息，因此以下會使用 "),e("em",[t._v("cache")]),t._v(" 來描述這個行為。")]),t._v(" "),e("p",[t._v("如果不希望使用 cache 的話，則可以在 "),e("code",[t._v("docker build")]),t._v(" 指令帶入 "),e("code",[t._v("--no-cache")]),t._v(" 參數即可。")])]),t._v(" "),e("p",[t._v("在執行 "),e("code",[t._v("COPY . .")]),t._v(" 時，要出現 Using cache 的額外條件是：來源內容必須要跟 cache 的一樣（Docker 應該有使用類似 md5 演算法，但不確定用了什麼），才會使用 cache。")]),t._v(" "),e("p",[t._v("這代表，僅僅只是修改 "),e("code",[t._v("README.md")]),t._v(" 就會造成 "),e("code",[t._v("COPY . .")]),t._v(" 重跑，進而讓 "),e("code",[t._v("RUN composer install")]),t._v(" 也重跑。")]),t._v(" "),e("p",[t._v("這問題的思考方向是：了解 "),e("code",[t._v("composer install")]),t._v(" 的依賴為哪些檔案，先把這些檔案複製進 image 後，再執行 "),e("code",[t._v("COPY . .")]),t._v("。")]),t._v(" "),e("p",[t._v("因此解決方法，原本的寫法如下：")]),t._v(" "),e("div",{staticClass:"language-dockerfile extra-class"},[e("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" . .\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" composer install\n")])])]),e("p",[t._v("改成：")]),t._v(" "),e("div",{staticClass:"language-dockerfile extra-class"},[e("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" composer.json .\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" composer.lock .\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" composer install\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" . .\n")])])]),e("p",[t._v("但因為 Laravel 架構設計，所以 "),e("code",[t._v("composer install")]),t._v(" 無法獨立執行，必須加上一點東西：")]),t._v(" "),e("div",{staticClass:"language-dockerfile extra-class"},[e("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" composer.json .\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" composer.lock .\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" mkdir "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p database/seeds\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" mkdir "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p database/factories\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" composer install "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("no"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("scripts\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" . .\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" composer install\n")])])]),e("h2",{attrs:{id:"env-改執行階段傳入"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#env-改執行階段傳入"}},[t._v("#")]),t._v(" ENV 改執行階段傳入")]),t._v(" "),e("p",[e("RouterLink",{attrs:{to:"/docs/exercises/exercises-11-environment-variable.html"}},[t._v("Environment")]),t._v(" 練習可以傳入指定的環境變數。而 Laravel 使用 "),e("code",[t._v(".env")]),t._v(" 檔載入環境變數，若要改成由執行階段傳入的話，首先得先把 "),e("code",[t._v(".env")]),t._v(" 忽略：")],1),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# .dockerignore\n.env\n")])])]),e("p",[t._v("接著使用 "),e("code",[t._v("docker run")]),t._v(" 的另一個參數 "),e("code",[t._v("--env-file")]),t._v(" 來載入環境變數：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("docker run --env-file .env laravel\n")])])]),e("p",[t._v("最後即可把 Dockerfile 的環境變數移除。")]),t._v(" "),e("h2",{attrs:{id:"精簡-aufs-的-commit-數"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#精簡-aufs-的-commit-數"}},[t._v("#")]),t._v(" 精簡 AUFS 的 commit 數")]),t._v(" "),e("p",[t._v("Docker 的 commit 數量是有限制的，為 127 個，這是精簡的理由之一。另一個更重大的理由是：因為 AUFS 系統特性，只要 commit 數越多，檔案系統的操作就會越慢，因此更需要想辦法來減少 commit 數。")]),t._v(" "),e("p",[t._v("以本例來說，把最上面安裝 composer 的過程合併，不失為一個好方法：")]),t._v(" "),e("div",{staticClass:"language-dockerfile extra-class"},[e("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" set "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("xe && \\\n        curl "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("sS https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//getcomposer.org/installer "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" php && \\\n        mv composer.phar /usr/local/bin/composer\n")])])]),e("h2",{attrs:{id:"最佳化後的-dockerfile"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#最佳化後的-dockerfile"}},[t._v("#")]),t._v(" 最佳化後的 Dockerfile")]),t._v(" "),e("div",{staticClass:"language-dockerfile extra-class"},[e("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" php"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.3"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alpine\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /source\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" set "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("xe && \\\n        curl "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("sS https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//getcomposer.org/installer "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" php && \\\n        mv composer.phar /usr/local/bin/composer\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" composer.json .\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" composer.lock .\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" set "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("xe && \\\n        mkdir "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p database/seeds && \\\n        mkdir "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p database/factories && \\\n        composer install "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("no"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("scripts\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" . .\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" composer install\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPOSE")]),t._v(" 8080\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"php"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"artisan"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"serve"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--host"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.0.0.0"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--port"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8080"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),e("h2",{attrs:{id:"references"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[t._v("#")]),t._v(" References")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://stackify.com/docker-performance-improvement-tips-and-tricks/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker Performance Improvement: Tips and Tricks"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://docs.docker.com/storage/storagedriver/aufs-driver/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Use the AUFS storage driver"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://coolshell.cn/articles/17061.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("DOCKER基础技术：AUFS"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=r.exports}}]);