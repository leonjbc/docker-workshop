(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{260:function(s,t,n){"use strict";n.r(t);var a=n(28),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"multi-stage-build"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#multi-stage-build"}},[s._v("#")]),s._v(" Multi-stage Build")]),s._v(" "),n("p",[s._v("上一個練習 "),n("RouterLink",{attrs:{to:"/docs/exercises/exercises-22-optimizing-dockerfile.html"}},[s._v("Optimizing Dockerfile")]),s._v(" 最後產生的 Dockerfile 如下：")],1),s._v(" "),n("div",{staticClass:"language-dockerfile extra-class"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("7.3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("xe && \\\n        curl "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("sS https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//getcomposer.org/installer "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" php && \\\n        mv composer.phar /usr/local/bin/composer\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.json .\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.lock .\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("xe && \\\n        mkdir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p database/seeds && \\\n        mkdir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p database/factories && \\\n        composer install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("scripts\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"php"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artisan"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--host"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--port"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),n("p",[s._v("這裡還有兩個很難解決的問題")]),s._v(" "),n("ul",[n("li",[s._v("Laravel 有使用 npm 套件建置前端程式，但環境只有 PHP，該怎麼辦？")]),s._v(" "),n("li",[s._v("最終建置出來的 Dockerfile，並不希望有任何開發或建置工具（如 Composer），該怎麼辦？")])]),s._v(" "),n("p",[s._v("這兩個問題，可以使用 Multi-stage Build 解決")]),s._v(" "),n("h2",{attrs:{id:"移出-composer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#移出-composer"}},[s._v("#")]),s._v(" 移出 Composer")]),s._v(" "),n("p",[s._v("參考官方文件，可以改寫成這樣：")]),s._v(" "),n("div",{staticClass:"language-dockerfile extra-class"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("7.3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine AS php_builder\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("xe && \\\n        curl "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("sS https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//getcomposer.org/installer "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" php && \\\n        mv composer.phar /usr/local/bin/composer\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.json .\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.lock .\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p database/seeds\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p database/factories\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dev "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("scripts\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("7.3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("from=php_builder /source/vendor ./vendor \n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"php"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artisan"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--host"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--port"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),n("p",[s._v("也因為分成不同階段建構，甚至第一階段的 Composer 安裝還能改寫成如下：")]),s._v(" "),n("div",{staticClass:"language-dockerfile extra-class"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("scripts\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" php vendor/bin/phpunit\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dev\n")])])]),n("h2",{attrs:{id:"加入-npm"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#加入-npm"}},[s._v("#")]),s._v(" 加入 npm")]),s._v(" "),n("p",[s._v("對有多階段的做法來說，只要加一個建置階段是 Node 環境即可：")]),s._v(" "),n("div",{staticClass:"language-dockerfile extra-class"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("7.3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine AS php_builder\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" set "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("xe && \\\n        curl "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("sS https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//getcomposer.org/installer "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" php && \\\n        mv composer.phar /usr/local/bin/composer\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.json .\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" composer.lock .\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p database/seeds\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p database/factories\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("scripts\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" php vendor/bin/phpunit\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" composer install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dev\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("10.15"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine AS npm_builder\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json .\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run production\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("7.3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /source\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("from=php_builder /source/vendor ./vendor\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("from=npm_builder /source/public/js ./public/js\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("from=npm_builder /source/public/css ./public/css\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("from=npm_builder /source/public/mix"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manifest.json ./public\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 8080\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"php"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artisan"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--host"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--port"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),n("p",[s._v("同時這也是最終的結果。")]),s._v(" "),n("h2",{attrs:{id:"references"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[s._v("#")]),s._v(" References")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://docs.docker.com/develop/develop-images/multistage-build/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Use multi-stage builds"),n("OutboundLink")],1)])]),s._v(" "),n("p",[s._v("其他最佳化後的 Dockerfile 範例參考：")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://github.com/MilesChou/docker-phalcon",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Phalcon"),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/MilesChou/docker-xdebug",target:"_blank",rel:"noopener noreferrer"}},[s._v("PHP with XDebug"),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/104corp/docker-php-testing",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Image with PHP extensions"),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/104corp/laravel-eloquent-generator",target:"_blank",rel:"noopener noreferrer"}},[s._v("Laravel Eloquent Generator"),n("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=e.exports}}]);